<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Document</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="description" content="Description">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/docsify@4/lib/themes/vue.css">
  <!-- 引入Gitalk CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
</head>

<body>
  <div id="app"></div>
  
  <script>
    window.$docsify = {
      name: '',
      repo: '',
      loadSidebar: true,
      loadNavbar: true,
      subMaxLevel: 1,
      plugins: [
        function(hook) {
          hook.doneEach(function() {
            // 延迟加载确保DOM完全渲染
            setTimeout(initGitalk, 500);
          });
        }
      ]
    };

    function initGitalk() {
      // 检查DOM是否存在
      const markdownSection = document.querySelector('.markdown-section');
      if (!markdownSection) {
        console.log('未找到Markdown内容区域，无法初始化Gitalk');
        return;
      }
      
      // 如果已存在Gitalk容器则不再初始化
      if (document.getElementById('gitalk-container')) return;
      
      // 创建评论容器
      const container = document.createElement('div');
      container.id = 'gitalk-container';
      container.style.marginTop = '50px';
      container.style.paddingTop = '20px';
      container.style.borderTop = '1px solid #eee';
      markdownSection.appendChild(container);
      
      // 初始化Gitalk（关键修改：设置createIssueManually为false）
      const gitalk = new Gitalk({
        clientID: 'Ov23likpTJkNymls370P',
        clientSecret: '2c86a6abc35d263c1abce5b48113c7a54face0b0', // 注意：生产环境应隐藏此密钥
        repo: 'blog-comments',  // 用于存储评论的仓库
        owner: 'lining-lo',
        admin: ['lining-lo'],  // 可以管理评论的用户
        id: location.pathname,  // 确保每个页面有独立评论
        title: document.title || location.pathname,  // 自动获取标题，避免空值
        distractionFreeMode: false,  // 全屏遮罩效果
        language: 'zh-CN',  // 语言设置
        createIssueManually: false,  // 允许自动创建Issue
        labels: ['Gitalk', '评论'],  // 自动创建的issue标签
      });
      
      try {
        gitalk.render('gitalk-container');
        console.log('Gitalk初始化成功');
      } catch (e) {
        console.error('Gitalk初始化失败:', e);
        // 显示友好错误提示
        const errorMsg = document.createElement('div');
        errorMsg.className = 'gitalk-error';
        errorMsg.style.color = '#e74c3c';
        errorMsg.style.marginTop = '20px';
        errorMsg.innerHTML = `
          <strong>评论加载失败</strong>
          <p>错误信息: ${e.message}</p>
          <p>请尝试刷新页面或稍后再试</p>
        `;
        markdownSection.appendChild(errorMsg);
      }
    }
  </script>
  
  <!-- Docsify v4 -->
  <script src="//cdn.jsdelivr.net/npm/docsify@4"></script>
  <!-- Gitalk JS -->
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
  
  <script>
    // 页面加载完成后尝试初始化
    window.addEventListener('load', function() {
      setTimeout(initGitalk, 1000);
    });
  </script>
</body>
</html>